<!DOCTYPE html>
<html lang="en">
<head>
<base href="https://cesiumjs.org/Cesium/Apps/Sandcastle/gallery/"
 >
<!--script>
var myurl=document.location.href;//autolaunch as localhost:8080 if in local mode
//http://localhost:8080/  file:///D:/cesium/Apps/Sandcastle/gallery/Camera_.html
if(myurl.indexOf("localhost:8080")<0 && myurl.indexOf("file:")>=0){
   var folder="/cesium/";
   var i=myurl.indexOf(folder)+folder.length;
   document.location.href="http://localhost:8080/"+myurl.substr(i,999);
}
</script-->
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/myCesiumheader.js"></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>myCesiumflight</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/requirejs-2.1.20/require.js"></script>
    <script type="text/javascript">
    require.config({
        baseUrl : '../../../Source',
        waitSeconds : 60
    });
    </script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html" onunload="subunload();" >
<!--style>
<-->
<style>
    @import url(../templates/bucket.css);
    @import url(../Build/Cesium/Widgets/widgets.css);
    #cesiumContainer {
          width: 70%;
		 height: 70%;
		 overflow: hidden;
      }
</style>
<!--div id="cesiumContainer" class="fullSize"></div-->
<div id="cesiumContainer" ></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar" style="position:absolute;top:0px;left:0px;z-index:300;" >
<a id="toggleLighting"></a>
<a id="fog"></a>
<div>B,N => motor -/+</div>
<div>arrows => turn / H => help</div>
<div id="fps">fps</div>
<div id="msg">msg</div>
<div id="msg2">msg2</div>
<div id="msg3">msg3</div>
<div>
	<select id="combo" onChange="subcombo();" onblur="" onfocus="">
          <option id="flyto">flyto</option>
          <option id="deauville marinas">deauville marinas</option>
          <option id="deauville plage">deauville plage</option>
          <option id="trouville plage">trouville plage</option>
          <option id="nancy">nancy</option>
          <option id="crickvenica">crickvenica</option>
          <option id="paris tolbiac">paris tolbiac</option>
          <option id="paris defense">paris defense</option>
          <option id="ivry romain roland">ivry romain roland</option>
          <option id="orsay">orsay</option>
          <option id="le barcares">le barcares</option>
          <option id="jerusalem">jerusalem</option>
          <option id="marseille">marseille</option>
          <option id="nice">nice</option>
          <option id="arcachon">arcachon</option>
          <option id="grenoble">grenoble</option>
          <option id="san francisco">san francisco</option>
          <option id="new york">new york</option>
          <option id="atlanta">atlanta</option>
          <option id="rio">rio</option>
          <option id="hong kong">hong kong</option>
          <option id="athenes">athenes</option>
          <option id="perth">perth</option>
          <option id="le caire">le caire</option>
          <option id="washington">washington</option>
          <option id="tajmahal">tajmahal</option>
     </select>
</div>
</div>
	<div id="mapdiv" style="position:absolute;top:4028px;left:0px;width:97%;height:95%;" >
    </div>
	<div id="mapdivmsg" style="position:absolute;top:4000px;left:0px;width:400px;height:20px;" >
	<input type="text" id="msgmap" onKeyUp="quitmsgmap();" maxlength="80" size="80" />
    </div>
	<div id="north" style="position:absolute;top:3000px;left:0px;width:8px;height:8px;" >
	<a>N</a>
    </div>
<script>
var apikey='&key=AIzaSyAH372ZH8QSQgRHsqdtqNxkLVpcp_XUUkE';
//put here your google static map apikey (=> https://developers.google.com/maps/documentation/static-maps/get-api-key)
//to get more than per ip apiusage quota (some thousands to 20 thousands per day) (its free)
</script>
<script src='https://code.responsivevoice.org/responsivevoice.js' type="text/javascript" ></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3" type="text/javascript" ></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/bousspng.js"></script>
<script src="http://chungkn1400.github.io/mywebglflight/mywebglflight/base64binary.js"></script>
<script src="http://chungkn1400.github.io/mywebglflight/mywebglflight/avion2mp3.js"></script>
<script src="http://chungkn1400.github.io/mywebglflight/mywebglflight/pneump3.js"></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/cockpit1png.js"></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/compaspng.js"></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/compas2png.js"></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/skydomejpg.js" ></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/radar2png.js" ></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/whitepng.js" ></script>
<script src="http://chungkn1400.github.io/mywebglflight/mywebglflight/alphajetobjtxt.js"></script>
<script src="http://chungkn1400.github.io/mywebglflight/mywebglflight/alphajetjpg.js"></script>
<script src="http://chungkn1400.github.io/mywebglflight/mywebglflight/jet4mp3.js"></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/models/f14objtxt.js" ></script>
<script src="http://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/models/f14jpg.js" ></script>
<script id="webaudio" >
var twebaudio=1;
try{
var audioctx = new (window.AudioContext || window.webkitAudioContext)();
var songlength;
function loadsound(source,url){
source.request = new XMLHttpRequest();
source.request.open('GET', url, true);
source.request.responseType = 'arraybuffer';
source.request.onload = function() {
var audioData = source.request.response;
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 1.0;
if(source.onload){source.onload();}
},
function(e){alert("Error with decoding audio data" + e.err);});
}
source.request.send();
}
function loadsound64(source,data){
var audioData = Base64Binary.decodeArrayBuffer(data.split(",")[1]);
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 1.0;
if(source.onload){source.onload();}
audioData=null;
},
function(e){alert("Error with decoding audio data" + e.err);});
}
function setvol(source,vol){
  if(source.gainNode){source.gainNode.gain.value = vol;}
}
function setspeed(source,speed){
  if(source.playbackRate){source.playbackRate.value=speed;}
}
function playloop(source){source.loop=true;source.start(0);}
function playsound(source) {if(!source.gainNode){return;}
  var sourcex = audioctx.createBufferSource(); // creates a sound source
  sourcex.buffer = source.buffer;  // tell the source which sound to play
  sourcex.loop=false;
  if(source.playbackRate){
     if(sourcex.playbackRate){sourcex.playbackRate.value=source.playbackRate.value;}
  }	 
  sourcex.connect(source.gainNode);       // connect the source to the audioctx's destination (the speakers)
  sourcex.start(0);                           // play the source now                                           // note: on older systems, may have to use deprecated noteOn(time);
}
//var wav="mp3",browser="";
//if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){wav="ogg";browser="firefox";};
//if(navigator.userAgent.toLowerCase().indexOf('chrome') > -1){wav="wav";};
//alert(navigator.userAgent+" "+wav);
var audiosrc="";
var myaudio = audioctx.createBufferSource();
myaudio.volume=0;
loadsound64(myaudio,avion2mp3);
myaudio.onload=function(){
 setTimeout("playloop(myaudio);",300);
 setTimeout("setvol(myaudio,0.3);",300);
 setTimeout("setspeed(myaudio,1.0);",300);
 }
var myaudiojet = audioctx.createBufferSource();
myaudiojet.volume=0;
loadsound64(myaudiojet,jet4mp3);
myaudiojet.onload=function(){
 setTimeout("playloop(myaudiojet);",320);
 setTimeout("setvol(myaudiojet,0.003);",320);
 setTimeout("setspeed(myaudiojet,1.0);",320);
 }
var myaudiopneu = audioctx.createBufferSource();
//audiosrc=folder+"pneu."+wav;
myaudiopneu.volume=0;
loadsound64(myaudiopneu,pneump3);
myaudiopneu.onload=function(){
 setTimeout("playsound(myaudiopneu);",500);
 setTimeout("setvol(myaudiopneu,0.4);",500);
 setTimeout("setspeed(myaudiopneu,1.0);",500);
 }
var tpneu=0,tsoundpneu=0;
function soundpneu(){
 if(tframe>tsoundpneu+1000){
   tsoundpneu=tframe;
   playsound(myaudiopneu);
   }
}
function closewebaudio(){
  myaudio.buffer=null;
  myaudiojet.buffer=null;
  myaudiopneu.buffer=null;
}
}catch(e){twebaudio=0;};
//if(twebaudio==1){alert(tpneu);soundpneu();}
</script>   
<script id="cesium_sandcastle_script">
var cssscale=2,cssscaley=1.4,windx=1000,windy=700;
var prefix="myCesiumflight_";
function removestorage(key){
if(localStorage){localStorage.removeItem(prefix+key);}
}
function loadstorage(key,namexx){
if(localStorage){var aux=localStorage.getItem(prefix+key);
	             if(aux){eval(namexx+"="+aux+";");}
}}
function loadstoragetext(key,namexx){
if(localStorage){var aux=localStorage.getItem(prefix+key);
	             if(aux){eval(namexx+"='"+formatname(aux)+"';");}
}}
function savestorage(key,xx){
    if(localStorage){
	   localStorage.setItem(prefix+key,xx);
}}
//var xxxx=1;
//savestorage('xxxx',0);
//removestorage('xxxx');
//loadstorage('xxxx','xxxx');alert(xxxx);
loadstorage('cssscale','cssscale');//alert(cssscale);
loadstorage('cssscaley','cssscaley');//alert(cssscaley);
function sizescreen(){
var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
var wx=parseInt(100/cssscale)+"%";
var wy=parseInt(100/cssscaley)+"%";
windx=parseInt(window.innerWidth/cssscale);
windy=parseInt(window.innerHeight/cssscaley);
document.getElementById("cesiumContainer").setAttribute("style",
  "border: none;top:0px;left:0px;width:"+wx+";height:"+wy+";-ms-transform: scale("+cssscale1+","+cssscaley1+"); /* IE 9 */-webkit-transform: scale("+cssscale+","+cssscaley+"); /* Chrome, Safari, Opera */transform: scale("+cssscale+","+cssscaley+");-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;");
if(cockpit){updatecockpit();}
}
sizescreen();
function subcssscale(){ 
var crlf=String.fromCharCode(10),msg="";
var cssx0=cssscale,cssy0=cssscaley;  
  if(cssscale<=1){cssscale=1.4;
  }else if(cssscale<=1.4+0.01){cssscale=2.0;
  }else if(cssscaley<=1){cssscaley=1.2;
  }else if(cssscaley<=1.2+0.01){cssscaley=1.4;
  }else if(cssscaley<=1.4+0.01){cssscaley=1.7;
  }else if(cssscaley<=1.7+0.01){cssscaley=2.0;
  }else{cssscale=1;cssscaley=1;}
  msg="cssscalex="+cssscale;
  if(cssscale==1){msg+=" normal";}
  if(Math.abs(cssscale-1.4)<0.01){msg+=" lowerres,faster";}
  if(Math.abs(cssscale-2.0)<0.01){msg+=" more lowerres,faster";}
  msg+=crlf+"cssscaley="+cssscaley;
  if(cssscaley==1){msg+=" normal";}
  if(Math.abs(cssscaley-1.2)<0.01){msg+=" lowerres,faster";}
  if(Math.abs(cssscaley-1.4)<0.01){msg+=" more lowerres,faster";}
  if(Math.abs(cssscaley-1.7)<0.01){msg+=" more lowerres,faster";}
  if(Math.abs(cssscaley-2.0)<0.01){msg+=" more lowerres,faster";}
  
  if(confirm("set cssscale to "+crlf+crlf+msg+crlf+"?")){
     sizescreen();
  }else{cssscale=cssx0;cssscaley=cssy0;}
subfocus();  
}
var myviewer,myCesium,myellipsoid,okinit=0;
function startup(Cesium) {
    'use strict';
//Sandcastle_Begin
//var viewer = new Cesium.CesiumWidget('cesiumContainer');//,{
var viewer = new Cesium.Viewer('cesiumContainer',{
    //scene3DOnly:true,
	animation:false,
    baseLayerPicker:false,
    //CesiumWidget
	geocoder:false,
	navigationHelpButton:false,
    fullscreenButton:false,
    homeButton:false,
    sceneModePicker:false,
    timeline:false
							   });
myviewer=viewer;
myCesium=Cesium;

var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : 'https://assets.agi.com/stk-terrain/world',
    requestWaterMask : true,
    requestVertexNormals : true
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;
viewer.scene.globe.enableLighting = false;
viewer.scene.fog.enabled = false;

Sandcastle.addToolbarButton('Lighting', function() {
    viewer.scene.globe.enableLighting = !viewer.scene.globe.enableLighting;
}, 'toggleLighting');

Sandcastle.addToolbarButton('fog', function() {
    viewer.scene.fog.enabled = !viewer.scene.fog.enabled;
}, 'fog');

var scene = viewer.scene;
var canvas = viewer.canvas;
canvas.setAttribute('tabindex', '0'); // needed to put focus on the canvas
canvas.onclick = function() {
    canvas.focus();
};
var ellipsoid = scene.globe.ellipsoid;
myellipsoid=ellipsoid;

// disable the default event handlers
scene.screenSpaceCameraController.enableRotate = false;
scene.screenSpaceCameraController.enableTranslate = false;
scene.screenSpaceCameraController.enableZoom = false;
scene.screenSpaceCameraController.enableTilt = false;
scene.screenSpaceCameraController.enableLook = false;
/*
var startMousePosition;
var mousePosition;
var flags = {
    looking : false,
    moveForward : false,
    moveBackward : false,
    moveUp : false,
    moveDown : false,
    moveLeft : false,
    moveRight : false
};

var handler = new Cesium.ScreenSpaceEventHandler(canvas);

handler.setInputAction(function(movement) {
    flags.looking = true;
    mousePosition = startMousePosition = Cesium.Cartesian3.clone(movement.position);
}, Cesium.ScreenSpaceEventType.LEFT_DOWN);

handler.setInputAction(function(movement) {
    mousePosition = movement.endPosition;
}, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

handler.setInputAction(function(position) {
    flags.looking = false;
}, Cesium.ScreenSpaceEventType.LEFT_UP);

function getFlagForKeyCode(keyCode) {
    switch (keyCode) {
	case vk_left:
	    return 'lookleft';
	case vk_right:
	    return 'lookright';
	case vk_down:
        return 'lookdown';
	case vk_up:
	    return 'lookup';		
    case 'N'.charCodeAt(0):
        return 'moveForward';
    case 'B'.charCodeAt(0):
        return 'moveBackward';
    case 'W'.charCodeAt(0):
        return 'moveForward';
    case 'S'.charCodeAt(0):
        return 'moveBackward';
    case 'Q'.charCodeAt(0):
        return 'moveUp';
    case 'E'.charCodeAt(0):
        return 'moveDown';
    case 'D'.charCodeAt(0):
        return 'moveRight';
    case 'A'.charCodeAt(0):
        return 'moveLeft';
    default:
        return undefined;
    }
}

document.addEventListener('keydown', function(e) {
    var flagName = getFlagForKeyCode(e.keyCode);
    if (typeof flagName !== 'undefined') {
        flags[flagName] = true;
    }
}, false);

document.addEventListener('keyup', function(e) {
    var flagName = getFlagForKeyCode(e.keyCode);
    if (typeof flagName !== 'undefined') {
        flags[flagName] = false;
    }
}, false);
*/
viewer.clock.onTick.addEventListener(function(clock) {
    var camera = viewer.camera;

    /*if (flags.looking) {
        var width = canvas.clientWidth;
        var height = canvas.clientHeight;

        // Coordinate (0.0, 0.0) will be where the mouse was clicked.
        var x = (mousePosition.x - startMousePosition.x) / width;
        var y = -(mousePosition.y - startMousePosition.y) / height;

        var lookFactor = 0.05;
        camera.lookRight(x * lookFactor);
        camera.lookUp(y * lookFactor);
    }*/

    /*var lookFactor = 0.035;
    if (flags.lookright) {
         camera.lookRight(lookFactor);}
    if (flags.lookleft) {
        camera.lookRight(-lookFactor);}
    if (flags.lookup) {
         camera.lookUp(lookFactor);}
    if (flags.lookdown) {
        camera.lookUp(-lookFactor);}
    
    // Change movement speed based on the distance of the camera to the surface of the ellipsoid.
    var cameraHeight = ellipsoid.cartesianToCartographic(camera.position).height;
    var moveRate = cameraHeight / 100.0;

    if (flags.moveForward) {
        camera.moveForward(moveRate);
    }
    if (flags.moveBackward) {
        camera.moveBackward(moveRate);
    }
    if (flags.moveUp) {
        camera.moveUp(moveRate);
    }
    if (flags.moveDown) {
        camera.moveDown(moveRate);
    }
    if (flags.moveLeft) {
        camera.moveLeft(moveRate);
    }
    if (flags.moveRight) {
        camera.moveRight(moveRate);
    }
	*/
	mytestkey();
});


//Sandcastle_End
    Sandcastle.finishedLoading();
	//san francisco
	/*var target = new Cesium.Cartesian3(-2708814.85583248, -4254159.450845907, 3891403.9457429945);
    var offset = new Cesium.Cartesian3(7064.66030209465, -3166.517948317807, 3550.179997143336);
    viewer.camera.lookAt(target, offset);
    viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
	x=-2708814.85583248;y=-4254159.450845907;z=3891403.9457429945;
    */
	loadstoragetext('flytoname','flytoname');
	loadstorage('flytolat','flytolat');
	loadstorage('flytolng','flytolng');
	document.getElementById('combo')[0].text=flytoname;
	loadstorage('icombo','icombo');
	document.getElementById('combo').selectedIndex=icombo;
	subcombo();
    //var positionxyz= myellipsoid.cartesianToCartographic(myviewer.camera.position);
    /*var positionxyz= myviewer.camera.positionCartographic;
    x=positionxyz.longitude;
    y=positionxyz.latitude;
    z=positionxyz.height;*/
	loadstorage('x','x');
	loadstorage('y','y');
	loadstorage('z','z');
	loadstorage('o1','o1');
	loadstorage('o2','o2');
	loadstorage('flaps','flaps');
    loadstorage('iplane','iplane');iplane-=1;subplane();
    loadstorage('vrun','vrun');
    loadstorage('vplane','vplane');
    lng=x;lat=y;
    cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
    cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
    cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));
	addaircraft();
    loadstorage('aircraftx','aircraftx');
    loadstorage('aircrafty','aircrafty');
    loadstorage('aircraftz','aircraftz');
    loadstorage('aircraftzsol','aircraftzsol');
    loadstorage('aircrafto1','aircrafto1');
	moveaircraft();
	addbouss();
	addcockpit();
	addsky();
	/*var center = target;//Cesium.Cartesian3.fromDegrees(-72.0, 40.0);
    var heading = Cesium.Math.toRadians(0.0);
    var pitch = Cesium.Math.toRadians(-20.0);   
    var range = 500.0;
    viewer.camera.lookAt(center, new Cesium.HeadingPitchRange(heading, pitch, range));	
    //viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
	*/
	okinit=1;

}
var quit=0,crlf=String.fromCharCode(10),auxvar=null,auxvar2=null,auxvar3=null;
var tframe=0,tframe0=0,tfps=30,fps=10,dtime=1,tmsg=0,tskip=0,itime=0,avgfps=10;
var cos1=1,sin1=0,cos2=1,sin2=0,cos3=1,sin3=0,v=120/2,klon=1,movexyz=0,tourelle=0,iview=2;
var flaps=0;
function mytestkey(){
        if(quit==1){return;}
		itime+=1;if(itime>10000){itime=0;}
		tframe0=tframe;
		tframe=timer();
		dtime=tframe-tframe0;
		if(dtime>180){dtime=180;}
		tfps+=(tframe-tframe0-tfps)*0.2;
		if(tfps<1){tfps=1;}
		if(tfps>1000){tfps=1000;}
		fps=1000/tfps;
		avgfps+=(fps-avgfps)*Math.min(1.0,dtime*0.001);
if(tframe>tmsg+150){
tmsg=tframe;
document.getElementById('fps').innerHTML="fps "+parseInt(avgfps);
var msg="x="+parseInt(x*100000)/100000+" y="+parseInt(y*100000)/100000+" z="+parseInt(z);
document.getElementById('msg').innerHTML=msg;
var msg2="v="+parseInt(v*20)/10+" prop="+parseInt(vrun*100);
msg2+=" o1="+parseInt(o1)+" o2="+parseInt(o2)+" o3="+parseInt(o3);
msg3="";
if(flaps>0){msg3+="flaps+"+flaps+" ";}
if(tourelle==1){msg3+="tourelle ";}
if(auxvar){msg3+=" aux="+auxvar;}
if(auxvar2){msg3+=" aux2="+auxvar2;}
if(auxvar3){msg3+=" aux3="+auxvar3;}
document.getElementById('msg2').innerHTML=msg2;
document.getElementById('msg3').innerHTML=msg3;
if(bouss){updatebouss();}
if(twebaudio==1){setvolume();}
}
var d10=0.010*dtime;
if(keys[vk_h]){
var msg="H => help"+crlf;
msg+="escape => save + quit"+crlf;
msg+="B,N => motor -/+"+crlf;
msg+="arrows => turn"+crlf;
msg+="F,G => flaps +/-"+crlf;
msg+="T => tourelle view"+crlf;
msg+="3 => cssscale (lowerres/faster)"+crlf;
msg+="M => map+click"+crlf;
msg+="shift+G => flyto geocoding"+crlf;
msg+="combobox => presets locations"+crlf;
msg+="V => view"+crlf;
msg+="K => jet/plane"+crlf;
msg+="R => radio off/on"+crlf;
alert(msg);
resetkeys();
}
if(keys[vk_escape]){quit=1;subquit();}
if(keys[vk_9]){subtest();resetkeys();}
if(keys[vk_r]){subradio();resetkeys();}
if(keys[vk_k]){subplane();resetkeys();}
if(keys[vk_v]){iview+=1;if(iview>2){iview=0;};resetkeys();}
if(keys[vk_m] || (keys[vk_space] && tmap==1)){
          if(tmap==0){tmap=1;showmap();subcentermap();}//map.setCenter(new google.maps.LatLng(latx,lngx));updatemarker();}
          else{tmap=0;}
          if(tmap!=1){hidemap();}
          document.getElementById('msgmap').value="lat="+lat+"  lng="+lng+"  z="+parseInt(z);
		  resetkeys();
} 
if(keys[vk_t]){tourelle=(tourelle+1)%2;resetkeys();} 
if(keys[vk_3]){subcssscale();resetkeys();} 
if(keys[vk_g] && keys[vk_shift]){geolocate();resetkeys();}
o10=o1;o20=o2;o30=o3;
if(tourelle==0  && landing==0){
 if(keys[vk_left]){o3+=d10*1.3;}
 if(keys[vk_right]){o3-=d10*1.3;}
 if(keys[vk_up]){o2-=d10*cos3;o1-=d10*sin3;}
 if(keys[vk_down]){o2+=d10*cos3;o1+=d10*sin3;;}
}else if(tourelle==0  && landing==1){
 if(keys[vk_left]){o1+=d10;}
 if(keys[vk_right]){o1-=d10;}
 if(keys[vk_up]){o2-=d10*cos3;o1-=d10*sin3;}
 if(keys[vk_down]){o2+=d10*cos3;o1+=d10*sin3;;}
}else{
 if(keys[vk_left]){to1+=d10*2;}
 if(keys[vk_right]){to1-=d10*2;}
 if(keys[vk_up]){to2+=d10*2;}
 if(keys[vk_down]){to2-=d10*2;}
}
if(keys[vk_f] && keys[vk_shift]==0 && flaps<20){flaps+=1;resetkeys();}
if(keys[vk_g] && keys[vk_shift]==0 && flaps>0){flaps-=1;resetkeys();}

if(tmap==1){scrollTo(0,4000);}
else{scrollTo(0,0);}
if(okinit>1 && z>zsol+4){
 var positionxyz= myviewer.camera.positionCartographic;
 //x=positionxyz.longitude;
 //y=positionxyz.latitude;
 z=positionxyz.height;
}
moveplane();
//cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
//cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
//cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));
/*if(o1>180){o1-=360;}
if(o1<-180){o1+=360;}
if(o2>180){o2-=360;}
if(o2<-180){o2+=360;}
if(o3>180){o3-=360;}
if(o3<-180){o3+=360;}*/
if(to1>180){to1-=360;}
if(to1<-180){to1+=360;}
if(to2>80){to2=79;}
if(to2<-80){to2=-79;}
//var camera=myviewer.camera;
//x=camera.position.x;
//y=camera.position.y;
//z=camera.position.z;
//var positionxyz= myellipsoid.cartesianToCartographic(myviewer.camera.position);
////var positionxyz= myviewer.camera.positionCartographic;
//x=positionxyz.longitude;
//y=positionxyz.latitude;
////z=positionxyz.height;
if(itime%20==1){setklon();}
//if(z<1){o2=Math.max(-6,o2);o3=0;}
//if(Math.abs(o3)>20){o1+=(sin3-sign(sin3)*0.1)*dtime*0.007;}
////if(keys[vk_n]){v=Math.min(200,v+dtime*0.025);}//x+=v*cos1*cos2/klon;y+=v*sin1*cos2;z+=v*sin2*500;}
////if(keys[vk_b]){v=Math.max(-20,v-dtime*0.025);}//x-=v*cos1*cos2/klon;y-=v*sin1*cos2;z-=v*sin2*500;}
v=200*vplane/2;//vplane:-0.5 .. 4.5 -100..900km/h
movexyz=v*dtime*0.0005;
if(okinit>=1){okinit=2;myview();moveaircraft();testgetways();testradio();}
}
function subtest(){//addaircraft();return;
soundpneu();
}
var wayx=-199,wayy=0;
function testgetways(){
if(Math.abs((wayx-x)*scale/klon)>400 || Math.abs((wayy-y)*scale)>400){
   wayx=x;wayy=y;
   getways();}
}
var button=[];for(var i=0;i<16;i++){button[i]=0;};
var vplane=0.5,vrun=1.3,vrunmax=1.7,tgaz=0,vplanez=0;
var do1=0,do2=0,do3=0,plane="c150",landing=0,tpiste=0,iplane=0,landing0=0;
function subplane(){
iplane+=1;if(iplane>2){iplane=0;}
var vrunmax0=vrunmax;
if(iplane==0){plane="c150";vrunmax=1.7;vplane*=vrunmax/vrunmax0;vrun*=vrunmax/vrunmax0;}
if(iplane==1){plane="alphajet";vrunmax=3;vplane*=vrunmax/vrunmax0;vrun*=vrunmax/vrunmax0;}
if(iplane==2){plane="f14";vrunmax=6;vplane*=vrunmax/vrunmax0;vrun*=vrunmax/vrunmax0;}
}
function moveplane(){
    var dt=dtime;
	tgaz=0;
	if (keys[vk_page_up] || keys[vk_n] || button[1]) {vrun+=dt*0.0003;tgaz=1;};
    if (keys[vk_page_down] || keys[vk_b] || button[2]) {
	    vrun-=dt*0.0003;if(vrun<0){vrun=0;if(landing==1){vplane-=vplane*dt*0.0001;}};};
	if(tgaz==0){if(vrun>vrunmax){vrun=vrunmax;};
	}else{if(vrun>vrunmax+0.3){vrun=vrunmax+0.3;}}
	//var air=(5000-z)/(5000+z);if(air<0){air=0;};
	var air=(10000-z)/(10000+z);if(air<0){air=0;};
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var kair=vrunmax/1.3;
	var vrun2=1;
	if(vrunmax<2.01){
	   vrun2=vrun*((3-1.4*vplane/kair)/2)*3*air*air/(2+air*air);
	}else{
	   vrun2=vrun*((3-1.4*vplane/kair)/2)*3*air*air*((2+kair)/3)/(2+air*air*kair);
	}	
	//vplane+=0.8*((vrun2)*0.0003*air*dt-dt*(air*0.0003*vplane+(sin2+0.03)*0.0024));
	vplane+=0.8*((vrun2)*0.0003*air*dt-dt*(air*0.0005*vplane+(sin2+0.01)*0.0007));
	if(vplane>4.5){vplane=4.5;}//max vv=900
	if(vplane<-0.5){vplane=-0.5;}//min vv=-100
    vcruise=0.75;
	if(plane=="spitfire"){vcruise=0.85;}
	else if(plane=="zero"){vcruise=0.84;}
	else if(plane=="corsair"){vcruise=0.84;}
	else if(plane=="alphajet"){vcruise=1.5;}
	else if(plane=="f14"){vcruise=3.0;}
	vcruise*=20/(20+flaps);
    if(Math.abs(o3)>10){o1+=(sin3-sign(sin3)*0.1)*dtime*0.007;}
	//o1+=sin3*dt*0.010;
	if(landing==0){o2-=Math.abs(Math.sin(degtorad(0.7*o3)))*dt*0.0015;}
	//if(z<zsol+1.82){landing=1;}else{landing=0;}
	if(landing==0){
	 if(cos3>0){o2+=(vplane*air-vcruise)*air*cos2*cos3*dt*0.004;}
	      else{o2+=(vplane*air+vcruise)*air*cos2*cos3*dt*0.004;}
	}
	if(o3>0.1){o3-=dt*0.001;}
	else if(o3<-0.1){o3+=dt*0.001;}
	//else if(landing==1){o3=0;}
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	do3+=(o3-o30)-dt1*do3;
	do2+=(o2-o20)-dt1*do2;
	do1+=(o1-o10)-dt1*do1;
	if(landing==1){
	  //if(landing0==0){if(twebaudio==1){soundpneu();};}
	  if(o2<-0.02){o2=-0.01;do2=0;sin2=0;};
	  if(tpiste==1 && vplane<0.07){o2=0;do2=0;sin2=0;}
	  if(o2>0.1 && vplane<0.05){do2-=dt*0.050;};
	  if(keys[vk_shift]){vplane-=0.000145*dt*vplane;};
	  vplane-=0.00003*dt*vplane;o3=0;if(vplane<0.003){vplane=0.000001;};}
	var dt2=dt*0.5;
	o1+=do1*dt2*0.001;
	o2+=do2*dt2*0.0025;
	o3+=do3*dt2*0.0025;
	if(Math.abs(o3)<1){o3+=Math.cos(tframe*0.0015)*0.2*(1-Math.abs(o3));};
	if(Math.abs(o2)<20 && z>zsol+4){o2+=Math.cos(tframe*0.0004)*0.02*Math.max(2,8-Math.abs(o2));};
	//var vdt=dt*0.013*vplane;
	//x+=vdt*cos1*cos2*klon/scale;
	//y+=vdt*sin1*cos2/scale;
	//z+=vdt*sin2;
	vplanez=vplane*sin2;
	if(Math.abs(vplane)<0.2 && landing==0 && z>zsol+0.6){z-=(0.2-Math.abs(vplane))*dt*0.013/3;vplanez-=(0.2-vplane)/3;
	                                       o2-=dt*0.004*cos2};
	if(o2>35){if(cos3>0){o1-=90*sin3*dt*0.004*sin2;o3-=90*sin3*dt*0.004*sin2;}else{
	                     o1+=90*sin3*dt*0.004*sin2;o3+=90*sin3*dt*0.004*sin2;};}
	if(o2<-35){if(cos3>0){o1-=90*sin3*dt*0.004*sin2;o3+=90*sin3*dt*0.004*sin2;}else{
	                     o1+=90*sin3*dt*0.004*sin2;o3-=90*sin3*dt*0.004*sin2;};}
    //if(o2>85){o2=84;o1=180+o1;o3=o3+180;};
    if(o2>85){o2=84;o1=180+o1-o3;o3=180;};
    if(o2<-85){o2=-84;o1=180+o1+o3;o3=0;};
	while(o1>180){o1-=360;} 
	while(o1<-180){o1+=360;}
	while(o3>180){o3-=360;}
	while(o3<-180){o3+=360;}
    cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
    cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
    cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));
}
var positionheight=0,positionheight0=0;
function getterrainheight(lngx,latx){
//if(positionheight){positionheight = new myCesium.Cartographic(longitude, latitude);}
//else{positionheight = new myCesium.Cartographic(longitude, latitude);}
//positionheight=myCesium.Cartographic.fromDegrees(lngx,latx,-1000);
var dz=positionheight;
if(dz>-99998){positionheight0=positionheight;}else{return positionheight0;}
positionheight=-99999;
var positions = [
    myCesium.Cartographic.fromDegrees(lngx,latx),
    myCesium.Cartographic.fromDegrees(aircraftx,aircrafty),
    myCesium.Cartographic.fromDegrees(aircraft2x,aircraft2y)
];
var promise = myCesium.sampleTerrain(myviewer.terrainProvider, 11, positions);
myCesium.when(promise, function(updatedPositions) {
    positionheight=positions[0].height;// and positions[1].height have been updated.
    positionheight0=positionheight;
    aircraftzsol=positions[1].height;
    aircraft2zsol=positions[2].height;
	// updatedPositions is just a reference to positions.
});
return positionheight0;
}
function updatebouss(){
var topOffset = 10;
var leftOffset = parseInt(windx-110/cssscale);
bouss.style.width = parseInt(100/cssscale)+'px';
//bouss.style.height = '60px';
bouss.style.top =  topOffset + 'px';
bouss.style.left = leftOffset + 'px';
var rotation=parseInt(o1-90) + 'deg';
if(tourelle==1){rotation=parseInt(o1+to1-90) + 'deg';}
bouss.style['-ms-transform'] = 'rotate(' + rotation + ')'; /* IE 9 */
bouss.style['-webkit-transform'] = 'rotate(' + rotation + ')'; /* Chrome, Safari, Opera */
bouss.style.transform = 'rotate(' + rotation + ')';
}
function subquit(){
  quit=1;
  savestorage('flytoname',flytoname);
  savestorage('flytolat',flytolat);
  savestorage('flytolng',flytolng);
  savestorage('icombo',icombo);
  savestorage('cssscale',cssscale);
  savestorage('cssscaley',cssscaley);
  savestorage('x',x);
  savestorage('y',y);
  savestorage('z',z);
  savestorage('o1',o1);
  savestorage('o2',o2);
  savestorage('flaps',flaps);
  savestorage('iplane',iplane);
  savestorage('vrun',vrun);
  savestorage('vplane',vplane);
  savestorage('aircraftx',aircraftx);
  savestorage('aircrafty',aircrafty);
  savestorage('aircraftz',aircraftz);
  savestorage('aircraftzsol',aircraftzsol);
  savestorage('aircrafto1',aircrafto1);
  sleep(300);//alert("bye !");
  document.location.href="http://chung.blogvie.com/links/";
}
function subunload(){
  quit=1;
  if(twebaudio==1){try{closewebaudio();}catch(e){};}
}
function sleep(ms){
var t=timer()+Math.min(10000,ms);
while(timer()<t){}
}
function setklon(){
var xyz0= myCesium.Cartesian3.fromDegrees(x,y,10000);
var xyz1= myCesium.Cartesian3.fromDegrees(x+0.1,y,10000);
var xyz2= myCesium.Cartesian3.fromDegrees(x,y+0.1,10000);
var dx1=xyz1.x-xyz0.x, dy1=xyz1.y-xyz0.y, dz1=xyz1.z-xyz0.z;
var dx2=xyz2.x-xyz0.x, dy2=xyz2.y-xyz0.y, dz2=xyz2.z-xyz0.z;
klon=Math.sqrt((dx2*dx2+dy2*dy2+dz2*dz2)/Math.max(0.00001,dx1*dx1+dy1*dy1+dz1*dz1));
}
var o1=30,o2=-14,o3=0,o10=0,o20=0,o30=0,x=0,y=0,z=0,x0=0,y0=0,z0=0;
var to1=170,to2=-20;
var zsol=0,aircraftzsol=0,aircraft2zsol=0;
function myview(){//return;
//o1=-45;o2=30;o3=45;
    var camera=myviewer.camera;
	/*camera.setView({
        //destination : myCesium.Cartesian3(300770.50872389384, 5634912.131394585, 2978152.2865545116),
        //destination : myCesium.Cartesian3.fromDegrees(-75.5847, 40.0397, 1000.0),
        orientation: {
            heading : degtorad(-o1),
            pitch : degtorad(o2),
            roll : degtorad(-o3)
        }
    });*/

//if(Math.abs(x0-x)+Math.abs(y0-y)+Math.abs((z0-z)/500)>0.000001){
landing0=landing;landing=0;
zsol=getterrainheight(x,y);
if(z<zsol-20){z=zsol+300.0;if(twebaudio==1){soundpneu();};}	
//if(Math.abs(movexyz)>0.0001){
    //if(tourelle==1){movexyz=-movexyz;}
    //camera.moveForward(movexyz);
	movexyz/=scale;
	x+=movexyz*klon*cos1*cos2;y+=movexyz*sin1*cos2;z+=movexyz*scale*sin2;
    //z=camera.positionCartographic.height;
	if(z<0.2+zsol){//camera.moveUp(movexyz*0.105);}
	     landing=1;
	     o2=Math.max(0,o2);o3=0;if(twebaudio==1 && landing0==0){soundpneu();};//landing=1;
	     z=0.199+zsol;movexyz=-movexyz*0.3;
	     x+=movexyz*klon*cos1*cos2;y+=movexyz*sin1*cos2;//z+=movexyz*scale*sin2;
	     //camera.moveUp(4-z+movexyz);
		 //camera.moveBackward(movexyz);
		 }
	movexyz=0;
	//x0=x;y0=y;z0=z;
//}
if(1 || Math.abs(o10-o1)+Math.abs(o20-o2)+Math.abs(o30-o3)>0.01){
	//var lookFactor = 0.005;
    //camera.lookRight((o10-o1) * lookFactor);
    //camera.lookUp((o2-o20) * lookFactor);
	var o11=o1,o22=o2,o33=o3;if(tourelle==1){o11+=to1;o22+=to2;o33=0;}
    camera.setView({
        //destination : myCesium.Cartesian3(300770.50872389384, 5634912.131394585, 2978152.2865545116),
        destination : myCesium.Cartesian3.fromDegrees(x,y,z),
        //positionCartographic: myCesium.Cartographic(x,y,z),
		orientation: {
            heading : degtorad(-o11+90),
            pitch : degtorad(o22-6),
            roll : degtorad(-o33)
        }});
}
if(iview!=1 || tourelle==1){
             updatespot0();updatespot1();updatespot2();updatespot3();
             cockpit.style.top='8000px';
             compas.style.top='8000px';compas2.style.top='8000px';
			 radar.style.top='8000px';spot.style.top='8000px';
			 spot0.style.top='8000px';spot1.style.top='8000px';
			 spot2.style.top='8000px';spot3.style.top='8000px';spotn.style.top='8000px';}
else{cockpit.style.top='0px';updatecompas();updateradar();}
if(iview==0){myentity2.show=false;jetmesh.show=false;f14mesh.show=false;}
else if(iview==1){myentity2.show=false;jetmesh.show=false;f14mesh.show=false;}
else{myentity2.show=true;
    var dr=51/scale,o11=o1-sin3*3;
	var co1=Math.cos(degtorad(o11));
	var si1=Math.sin(degtorad(o11));
	aircraft2x=x+klon*dr*co1*cos2;
	aircraft2y=y+dr*si1*cos2;
	aircraft2z=z+scale*dr*sin2-3*cos3;
	if(aircraft2z<aircraft2zsol+0.05){landing=1;aircraft2z=aircraft2zsol+0.0499;
	                                 o2=Math.max(0,o2);o3=0;z=zsol+0.199;
									 if(twebaudio==1 && landing0==0){soundpneu();}}
	aircraft2o1=-o11-sin3*12;
	aircraft2o2=o2+10+sin2*20;
	aircraft2o3=o3;
    var position = myCesium.Cartesian3.fromDegrees(aircraft2x,aircraft2y,aircraft2z);
    //var position = myCesium.Cartesian3.fromDegrees(x,y,z-1);
    var heading = degtorad(aircraft2o1);
    var pitch = degtorad(aircraft2o2);
    var roll = degtorad(-aircraft2o3);
    if(plane=="alphajet"){
	   myentity2.show=false;
	   jetmesh.show=true;
	   f14mesh.show=false;
	   var mymatrix=new myCesium.Transforms.headingPitchRollToFixedFrame(position, heading, pitch, roll);//myCesium.Matrix3.fromRotationY(degtorad(30));
       jetmesh.modelMatrix = mymatrix;
    }else if(plane=="f14"){
	   myentity2.show=false;
	   jetmesh.show=false;
	   f14mesh.show=true;
	   var mymatrix=new myCesium.Transforms.headingPitchRollToFixedFrame(position, heading, pitch, roll);//myCesium.Matrix3.fromRotationY(degtorad(30));
       f14mesh.modelMatrix = mymatrix;
	}else{
	   myentity2.show=true;
	   jetmesh.show=false;
	   f14mesh.show=false;
       var orientation = myCesium.Transforms.headingPitchRollQuaternion(position, heading, pitch, roll);
	   myentity2.orientation=orientation;
       myentity2.position=position;
	   }
}
if(sky){updatesky();}
}
var icombo=3,combotext="deauville marinas";
var lat=48.8261252,lng=2.35705595;
var flytolat=48.8261252,flytolng=2.35705595;
var flytoname="flyto",combolat=lat,combolng=lng;
function formatname(text){
var exclude='&",;?#'+"'",text1="",c="";
for(var i=0;i<text.length;i++){c=text.substr(i,1);if(exclude.indexOf(c)<0){text1+=c;}else{text1+=" ";}}
return text1;
}
function subcombo(){
icombo=document.getElementById('combo').selectedIndex;
combotext = document.getElementById('combo')[icombo].id ;
//var o1=0;
lat=flytolat;lng=flytolng;
//if (combotext=="initial"){lat=48.826125  ;lng=2.357055   ;o1=120;}
if (combotext=="flyto"){lat=flytolat  ;lng=flytolng   ;o1=10;}
if (combotext=="deauville marinas"){lat=49.36198047661674   ;lng=0.07262960190958628   ;o1=120;}
if (combotext=="deauville plage"){lat=49.35600551121942   ;lng=0.06075459446313726   ;o1=110;}
if (combotext=="trouville plage"){lat=49.36663106706898   ;lng=0.07818353983048315   ;o1=130;}
if (combotext=="nancy"){lat=48.69306979368741   ;lng=6.182922715725031   ;o1=70;}
if (combotext=="crickvenica"){lat=45.1734569955986   ;lng=14.689314428610118   ;o1=-110;}
if (combotext=="paris tolbiac"){lat=48.826125291730506   ;lng=2.3570559500472212   ;o1=0;}
if (combotext=="paris defense"){lat=48.891977155490395   ;lng=2.237673523003608   ;o1=160;}
if (combotext=="ivry romain roland"){lat=48.80346335679542   ;lng=2.3934673532940915   ;o1=-50;}
if (combotext=="orsay"){lat=48.706787   ;lng=2.180894999999964   ;o1=-30;}
if (combotext=="le barcares"){lat=42.78764305091493   ;lng=3.0338932951133533   ;o1=175;} 
if (combotext=="jerusalem"){lat=31.776636707589287   ;lng=35.2337121963501   ;o1=36.3920;}
if (combotext=="marseille"){lat=43.2803905;lng=5.405139   ;o1=36.3920;}
if (combotext=="nice"){lat=43.7031905;lng=7.252817  ;o1=36.3920;}
if (combotext=="arcachon"){lat=44.6514284;lng=-1.171656  ;o1=36.3920;}
if (combotext=="grenoble"){lat=45.1841656;lng=5.7155425 ;o1=36.3920;}
if (combotext=="san francisco"){lat=37.7577;lng=-122.4376 ;o1=36.3920;}
if (combotext=="new york"){lat=40.7033121;lng=-73.97968 ;o1=36.3920;}
if (combotext=="atlanta"){lat=33.7677129;lng=-84.42060 ;o1=36.3920;}
if (combotext=="rio"){lat=-22.8650853;lng=-43.13109 ;o1=36.3920;}
if (combotext=="hong kong"){lat=22.3700556;lng=114.153758 ;o1=36.3920;}
if (combotext=="athenes"){lat=37.9908372;lng=23.7383394 ;o1=36.3920;}
if (combotext=="perth"){lat=-31.9546529;lng=115.852662 ;o1=36.3920;}
if (combotext=="le caire"){lat=30.04441959;lng=31.23571160;o1=36.3920;}
if (combotext=="washington"){lat=38.8850399;lng=-77.08054296;o1=36.3920;}
if (combotext=="tajmahal"){lat=27.17015;lng=78.002155;o1=36.3920;}
document.getElementById('combo').blur();
o2=-4;o3=0;x=lng;y=lat;z=300.0;
myviewer.camera.setView({
    destination : myCesium.Cartesian3.fromDegrees(lng, lat, z),
	orientation: {
            heading : degtorad(-o1+90),
            pitch : degtorad(o2-6),
            roll : degtorad(-o3)}
});
setklon();
subfocus();
}
function subfocus(){
//document.getElementById('msg').focus();
myviewer.canvas.focus();
}
function subflyto(lng,lat){
o2=-4;o3=0;x=lng;y=lat;z=300.0;
//myviewer.camera.flyTo({
myviewer.camera.setView({
    destination : myCesium.Cartesian3.fromDegrees(lng, lat, z),
	orientation: {
            heading : degtorad(-o1+90),
            pitch : degtorad(o2-6),
            roll : degtorad(-o3)}
});
setklon();
}
var geolocation="";
function geolocate(){
geolocation = "paris france";
geolocation=window.prompt("flyto : enter address or location");
//alert("geolocation="+geolocation);
if (geolocation.length>0){
  var geocoder = new google.maps.Geocoder();
  geocoder.geocode( { 'address': geolocation}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      var latlng=results[0].geometry.location;
	  lat=latlng.lat();
	  lng=latlng.lng();
	  flytolat=lat;flytolng=lng;flytoname=formatname(geolocation);
	  icombo=0;
	  document.getElementById('combo')[icombo].text=flytoname;
	  document.getElementById('combo').selectedIndex=icombo;
	  subflyto(lng,lat);
    } else {
      alert('Geolocation not found ! ' + status);
    }
  });
}
subfocus();
}
var myentity,myentity2,scale=40000.0*1000/360;
var aircraftx=0,aircrafty=0,aircraftz=0,aircrafto1=0,aircrafto2=0,aircrafto3=0;
var aircraft2x=0,aircraft2y=0,aircraft2z=0,aircraft2o1=0,aircraft2o2=0,aircraft2o3=0;
var mymesh,mygeometry;
var positions = new Float64Array([
  100.0, 0.0, 0.0,
  75.0, 0.0, 100.0,
  0.0, 75.0, 0.0
]);
var textcoords = new Float32Array([
  0.0, 0.0,
  0.0, 1.0,
  1.0, 0.0
]);
var vertexCount = 0;
var vertexPositions = [];
var vertexTextureCoords = [];
function loadmygeometry(myobjtxt,scale){
handleLoadedWorld(myobjtxt,scale);
return addmygeometry(vertexPositions,vertexTextureCoords);
}
function handleLoadedWorld(data,scale){//,vertexposbuff,vertextextbuff) { 
    var lines = data.split("\n");
    vertexCount = 0;
    vertexPositions = [];
    vertexTextureCoords = [];
    for (var i in lines) {
      var vals = lines[i].replace(/^\s+/, "").split(/\s+/);
      if (vals.length == 5 && vals[0] != "//") {
        // It is a line describing a vertex; get X, Y and Z first
        vertexPositions.push(parseFloat(vals[0])*scale);
        vertexPositions.push(parseFloat(vals[1])*scale);
        vertexPositions.push(parseFloat(vals[2])*scale);

        // And then the texture coords
        vertexTextureCoords.push(parseFloat(vals[3]));
        vertexTextureCoords.push(parseFloat(vals[4]));

        vertexCount += 1;
      }
    }
}
function addmygeometry(positions,textcoords){
var mygeometry = new myCesium.Geometry({
  attributes : {
    position : new myCesium.GeometryAttribute({
      componentDatatype : myCesium.ComponentDatatype.DOUBLE,
	  componentsPerAttribute : 3,
	  values : positions
    }),
    normal : new myCesium.GeometryAttribute({
      componentDatatype : myCesium.ComponentDatatype.FLOAT,
	  componentsPerAttribute : 3,
	  values : positions
    }),
    st : new myCesium.GeometryAttribute({
      componentDatatype : myCesium.ComponentDatatype.FLOAT,
	  componentsPerAttribute : 2,
	  values : textcoords
    })
  },
  primitiveType : myCesium.PrimitiveType.TRIANGLES,
  boundingSphere : myCesium.BoundingSphere.fromVertices(positions)
});
return mygeometry;
}
function addmymesh(mygeometry,imageurl){
//var modelMatrix = myCesium.Transforms.eastNorthUpToFixedFrame(
//    myCesium.Cartesian3.fromDegrees(x,y,z));
var mymesh=new myCesium.Primitive({
        geometryInstances : new myCesium.GeometryInstance({
            geometry : mygeometry
            }),
        //modelMatrix : modelMatrix,
		//debugShowBoundingVolume : true,
        asynchronous: false,
		cull : false,
		show : true,
		appearance : new myCesium.MaterialAppearance({
		   //translucent : false,
		   material : new myCesium.Material({
		       fabric : {
                   type : 'Image',
                   uniforms : {
		              image : imageurl//bousspng
                   }
			   }
			  })
			})
    });
return mymesh;
}
var jetgeometry,jetmesh,f14geometry,f14mesh;	
function createmymesh(){
var scale=0.1;
jetgeometry=loadmygeometry(alphajetobjtxt,scale);//addmygeometry(positions,textcoords);
jetmesh=addmymesh(jetgeometry,alphajetjpg);
myviewer.scene.primitives.add(jetmesh);
scale=0.09;
f14geometry=loadmygeometry(f14objtxt,scale);//addmygeometry(positions,textcoords);
f14mesh=addmymesh(f14geometry,f14jpg);
myviewer.scene.primitives.add(f14mesh);

var position = myCesium.Cartesian3.fromDegrees(x,y,z+10);
var heading = degtorad(aircrafto1);
var pitch = degtorad(aircrafto2);
var roll = degtorad(-aircrafto3);
var mymatrix=new myCesium.Transforms.headingPitchRollToFixedFrame(position, heading, pitch, roll);//myCesium.Matrix3.fromRotationY(degtorad(30));
jetmesh.modelMatrix = mymatrix;
f14mesh.modelMatrix = mymatrix;
}
function createModel(url, height) {
    myviewer.entities.removeAll();
	
	createmymesh();

    var dr=200/scale;
	aircraftx=x+klon*dr*cos1*cos2;
	aircrafty=y+dr*sin1*cos2;
	aircraftz=z+scale*dr*sin2;
	aircrafto1=0;
    var position = myCesium.Cartesian3.fromDegrees(aircraftx,aircrafty,aircraftz);
    //var position = myCesium.Cartesian3.fromDegrees(x,y,z-1);
    var heading = degtorad(aircrafto1);
    var pitch = degtorad(aircrafto2);
    var roll = degtorad(-aircrafto3);
    var orientation = myCesium.Transforms.headingPitchRollQuaternion(position, heading, pitch, roll);

    var entity = myviewer.entities.add({
        name : url,
        position : position,
        orientation : orientation,
        model : {
            uri : url,
            minimumPixelSize : 20,
            maximumScale : 200000
        }
    });
    //myviewer.trackedEntity = entity;
	myentity=entity;

    var position2 = myCesium.Cartesian3.fromDegrees(x,y,z);
    orientation = myCesium.Transforms.headingPitchRollQuaternion(position2, heading, pitch, roll);
    var entity2 = myviewer.entities.add({
        name : url,
        position : position2,
        orientation : orientation,
        model : {
            uri : url,
            minimumPixelSize : 200,
            maximumScale : 200000
        }
    });
    //myviewer.trackedEntity = entity2;
	myentity2=entity2;
}
function addaircraft(){
   //createModel('../../SampleData/models/CesiumAir/Cesium_Air.glb', 300);
   createModel('https://chungkn1400.github.io/myCesiumflight/myCesiumflight/cesium/Apps/Sandcastle/myApps/models/Cesium_Air.glb', 300);
   //createModel('../../Sandcastle/myApps/SC001jet.glb', 300);
   //createModel('../../Sandcastle/myApps/c150.glb', 300);
}
function moveaircraft(){
//alert(myviewer.trackedEntity);
//if(myviewer.trackedEntity){myviewer.trackedEntity=null;alert(myviewer.trackedEntity);}
//else{myviewer.trackedEntity = myentity;}
//var dr=10.0/scale;
//var zz=Math.max(10,z+scale*dr*sin2);auxvar=zz;
//var position = myCesium.Cartesian3.fromDegrees(x+dr*cos1*cos2,y+klon*dr*sin1*cos2,zz);
/*var heading = myCesium.Math.toRadians(0);
var pitch = o2;
var roll = -o3;
// create an orientation based on the new position
var orientation = myCesium.Transforms.headingPitchRollQuaternion(position, heading, pitch, roll);
*/
var dxmax=klon*10000/scale,dymax=10000/scale,test=0;//10km
if(aircraftx>x+dxmax){aircraftx=x-0.99*dxmax;test=1;}
if(aircraftx<x-dxmax){aircraftx=x+0.99*dxmax;test=1;}
if(aircrafty>y+dymax){aircrafty=y-0.99*dymax;test=1;}
if(aircrafty<y-dymax){aircrafty=y+0.99*dymax;test=1;}
aircraftz+=(Math.max(aircraftzsol+250.0,z-150.0)-aircraftz)*dtime*0.001;
var vv=55,dx=vv*dtime*0.001/scale;
aircraftx+=dx;
aircrafto1=0;
    var position = myCesium.Cartesian3.fromDegrees(aircraftx,aircrafty,aircraftz);
    //var position = myCesium.Cartesian3.fromDegrees(x,y,z-1);
    var heading = degtorad(-aircrafto1);
    var pitch = degtorad(aircrafto2);
    var roll = degtorad(-aircrafto3);
    var orientation = myCesium.Transforms.headingPitchRollQuaternion(position, heading, pitch, roll);
myentity.orientation=orientation;
myentity.position=position;
}
var bouss;
function addbouss() {
            //Add overlay by creating an HTML element
            bouss = document.createElement('img');
            bouss.src = bousspng;//'_bouss.png';
            myviewer.container.appendChild(bouss);
			var rotation = parseInt(o1-90) + 'deg';
            var topOffset = 10;
            var leftOffset = parseInt(windx-110/cssscale);
            //Position overlay with CSS styling
            bouss.style.width = parseInt(100/cssscale)+'px';
            //bouss.style.height = '60px';
            bouss.style.position = 'absolute';
            bouss.style.top = 'calc('+topOffset + 'px)';
            bouss.style.left = 'calc('+leftOffset + 'px)';
            bouss.style['pointer-events'] = 'none';
            bouss.style['-ms-transform'] = 'rotate(' + rotation + ')'; /* IE 9 */
            bouss.style['-webkit-transform'] = 'rotate(' + rotation + ')'; /* Chrome, Safari, Opera */
            bouss.style.transform = 'rotate(' + rotation + ')';
}
var cockpit;
function addcockpit() {
            //Add overlay by creating an HTML element
            cockpit = document.createElement('img');
            cockpit.src = cockpit1png;//'cockpit1.png';
            myviewer.container.appendChild(cockpit);
            updatecockpit();
			addcompas();
			updatecompas();
			addradar();
			updateradar();
}
function updatecockpit(){
            if(!cockpit){return;}
			var rotation = parseInt(0) + 'deg';
            var topOffset = 0;
            var leftOffset = 0;
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            //Position overlay with CSS styling
            cockpit.style.width = parseInt(windx)+'px';
            //cockpit.style.height = '60px';
            cockpit.style.position = 'absolute';
            cockpit.style.top = 'calc('+topOffset + 'px)';
            cockpit.style.left = 'calc('+leftOffset + 'px)';
            cockpit.style['pointer-events'] = 'none';
            cockpit.style['-ms-transform'] =  "scale("+1+","+(cssscale1/cssscaley1)+")"; /* IE 9 */
            cockpit.style['-webkit-transform'] = "scale("+1+","+(cssscale/cssscaley)+")"; /* Chrome, Safari, Opera */
            cockpit.style.transform = "scale("+1+","+(cssscale/cssscaley)+")";
            cockpit.style['-ms-transform-origin'] =  "0 0"; /* IE 9 */
            cockpit.style['-webkit-transform-origin'] = "0 0"; /* Chrome, Safari, Opera */
            cockpit.style['transform-origin'] = "0 0";
            //cockpit.setAttribute("style",
  //"border: none;top:0px;left:0px;width:"+wx+";height:"+wy+";-ms-transform: scale("+cssscale1+","+cssscaley1+"); /* IE 9 */-webkit-transform: scale("+cssscale+","+cssscaley+"); /* Chrome, Safari, Opera */transform: scale("+cssscale+","+cssscaley+");-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;");
// scale("+cssscale1+","+cssscaley1+"); /* IE 9 */-webkit-transform: scale("+cssscale+","+cssscaley+"); /* Chrome, Safari, Opera */transform: scale("+cssscale+","+cssscaley+");-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;");
}
var compas;
function addcompas() {
            //Add overlay by creating an HTML element
            compas = document.createElement('img');
            compas.src = compaspng;//'compas.png';
            myviewer.container.appendChild(compas);
            updatecompas();
			addcompas2();
}
function updatecompas(){
            if(!compas){return;}
			var rotation = parseInt(o3) + 'deg';
            var topOffset = windy-150/cssscaley;
            var leftOffset = windx*0.28;
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(145/cssscale)+"%";
            //var wy=parseInt(100/cssscaley)+"%";
            //Position overlay with CSS styling
            compas.style.width = parseInt(wx)+'px';
            //compas.style.height = '60px';
            compas.style.position = 'absolute';
            compas.style.top = 'calc('+topOffset + 'px)';
            compas.style.left = 'calc('+leftOffset + 'px)';
            compas.style['pointer-events'] = 'none';
            compas.style['-ms-transform'] =  "scale("+1+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            compas.style['-webkit-transform'] = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            compas.style.transform = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")";
updatecompas2();
}
var compas2;
function addcompas2() {
            //Add overlay by creating an HTML element
            compas2 = document.createElement('img');
            compas2.src = compas2png;//'compas2.png';
            myviewer.container.appendChild(compas2);
            updatecompas2();
}
function updatecompas2(){
            if(!compas2){return;}
			var rotation = parseInt(o3) + 'deg';
            var topOffset = windy-150/cssscaley;
            var leftOffset = windx*0.28;
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(145/cssscale)+"%";
			var co2=cos2*(1-Math.abs(sin2))*0.95;
            //var wy=parseInt(100/cssscaley)+"%";
            //Position overlay with CSS styling
            compas2.style.width = parseInt(wx)+'px';
            //compas2.style.height = '60px';
            compas2.style.position = 'absolute';
            compas2.style.top = 'calc('+topOffset + 'px)';
            compas2.style.left = 'calc('+leftOffset + 'px)';
            compas2.style['pointer-events'] = 'none';
            compas2.style['-ms-transform'] =  "scale("+1+","+(cssscale1/cssscaley1)+") rotate("+rotation+") scale(1,"+co2+")"; /* IE 9 */
            compas2.style['-webkit-transform'] = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+") scale(1,"+co2+")"; /* Chrome, Safari, Opera */
            compas2.style.transform = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+") scale(1,"+co2+")";
}
var radar,spot,spot0,spot1,spot2,spot3,spotn;
function addradar() {
            //Add overlay by creating an HTML element
            radar = document.createElement('img');
            radar.src = radar2png;//'radar2.png';
            myviewer.container.appendChild(radar);
            spot = document.createElement('img');
            spot.src = whitepng;//'white.png';
            myviewer.container.appendChild(spot);
            spot0 = document.createElement('img');
            spot0.src = whitepng;//'white.png';
            myviewer.container.appendChild(spot0);
            spot1 = document.createElement('img');
            spot1.src = whitepng;//'white.png';
            myviewer.container.appendChild(spot1);
            spot2 = document.createElement('img');
            spot2.src = whitepng;//'white.png';
            myviewer.container.appendChild(spot2);
            spot3 = document.createElement('img');
            spot3.src = whitepng;//'white.png';
            myviewer.container.appendChild(spot3);
            spotn = document.getElementById('north');
            myviewer.container.appendChild(spotn);
            updateradar();
			var dr=1000*klon/scale;
			port0x=x;port0y=y;
			port1x=x+dr;port1y=y;
			port2x=x-dr;port2y=y;
			port3x=x;port3y=y+dr;
}
var o1radar=0;
function updateradar(){
            if(!radar){return;}
			o1radar+=30*dtime*0.002;if(o1radar>3600){o1radar-=3600;}
			var rotation = parseInt(-o1radar) + 'deg';
            var topOffset = windy-150/cssscaley;
            var leftOffset = windx*(0.59);
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(145/cssscale)+"%";
            //var wy=parseInt(100/cssscaley)+"%";
            //Position overlay with CSS styling
            radar.style.width = parseInt(wx)+'px';
            //radar.style.height = '60px';
            radar.style.position = 'absolute';
            radar.style.top = 'calc('+topOffset + 'px)';
            radar.style.left = 'calc('+leftOffset + 'px)';
            radar.style['pointer-events'] = 'none';
            radar.style['-ms-transform'] =  "scale("+1+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            radar.style['-webkit-transform'] = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            radar.style.transform = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")";
        
		updatespot();
}
function updatespot(){
            if(!spot){return;}
			var dx=cos1,dy=cos1;
			var dxx=(aircraftx-x)*scale/klon;
			var dyy=(aircrafty-y)*scale;
			var dmax=1500,dxy=Math.sqrt(dxx*dxx+dyy*dyy);
			dxx=dxx/(dmax+dxy);
			dyy=dyy/(dmax+dxy);
			dx=dxx*sin1-dyy*cos1;
			dy=dxx*cos1+dyy*sin1;
            var wx0=parseInt(145/cssscale);
			var rotation = parseInt(0) + 'deg';
            var topOffset = windy-150/cssscaley+wx0*(0.5-dy*0.5*cssscale/cssscaley);
            var leftOffset = windx*(0.59)+wx0*(0.5+dx*0.5);
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(5/cssscale);//+"%";
            //var wy=parseInt(100/cssscaley)+"%";
            //Position overlay with CSS styling
            spot.style.width = parseInt(wx)+'px';
            //spot.style.height = '60px';
            spot.style.position = 'absolute';
            spot.style.top = 'calc('+topOffset + 'px)';
            spot.style.left = 'calc('+leftOffset + 'px)';
            spot.style['pointer-events'] = 'none';
            spot.style['-ms-transform'] =  "scale("+1+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            spot.style['-webkit-transform'] = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            spot.style.transform = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")";

			updatespot0();
			updatespot1();
			updatespot2();
			updatespot3();
			updatespotn();
}
var port0x=0,port0y=0,port0dist=0,port1dist=0,port2dist=0,port3dist=0;
var port0name="",port1name="",port2name="",port3name="";
function updatespot0(){
            if(port0x<-191){
			   port0dist=99999;
               spot0.style.top = 3000 + 'px';return;
			}
			var dxx=(port0x-x)*scale/klon;
			var dyy=(port0y-y)*scale;
			var dmax=1900,dxy=Math.sqrt(dxx*dxx+dyy*dyy);
			port0dist=dxy;
			if(dxy>20000){
               spot0.style.top = 3000 + 'px';return;
			}
			dxx=dxx/(dmax+dxy);
			dyy=dyy/(dmax+dxy);
			var dx=dxx*sin1-dyy*cos1;
			var dy=dxx*cos1+dyy*sin1;
            var wx0=parseInt(145/cssscale);
			var rotation = parseInt(0) + 'deg';
            var topOffset = windy-150/cssscaley+wx0*(0.5-dy*0.5*cssscale/cssscaley);
            var leftOffset = windx*(0.59)+wx0*(0.5+dx*0.5);
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(2/cssscale);
            spot0.style.width = parseInt(wx)+'px';
            spot0.style['pointer-events'] = 'none';
            spot0.style['-ms-transform'] =  "scale("+3.5+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            spot0.style['-webkit-transform'] = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            spot0.style.transform = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")";
            spot0.style.position = 'absolute';
            spot0.style.top = topOffset + 'px';
            spot0.style.left = leftOffset + 'px';			
}
var port1x=0,port1y=0;
function updatespot1(){
            if(port1x<-191){
			   port1dist=99999;
               spot1.style.top = 3000 + 'px';return;
			}
			var dxx=(port1x-x)*scale/klon;
			var dyy=(port1y-y)*scale;
			var dmax=1900,dxy=Math.sqrt(dxx*dxx+dyy*dyy);
			port1dist=dxy;
			if(dxy>20000){
               spot1.style.top = 3000 + 'px';return;
			}
			dxx=dxx/(dmax+dxy);
			dyy=dyy/(dmax+dxy);
			var dx=dxx*sin1-dyy*cos1;
			var dy=dxx*cos1+dyy*sin1;
            var wx0=parseInt(145/cssscale);
			var rotation = parseInt(0) + 'deg';
            var topOffset = windy-150/cssscaley+wx0*(0.5-dy*0.5*cssscale/cssscaley);
            var leftOffset = windx*(0.59)+wx0*(0.5+dx*0.5);
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(2/cssscale);
            spot1.style.width = parseInt(wx)+'px';
            spot1.style['pointer-events'] = 'none';
            spot1.style['-ms-transform'] =  "scale("+3.5+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            spot1.style['-webkit-transform'] = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            spot1.style.transform = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")";
            spot1.style.position = 'absolute';
            spot1.style.top = topOffset + 'px';
            spot1.style.left = leftOffset + 'px';			
}
var port2x=0,port2y=0;
function updatespot2(){
            if(port2x<-191){
			   port2dist=99999;
               spot2.style.top = 3000 + 'px';return;
			}
			var dxx=(port2x-x)*scale/klon;
			var dyy=(port2y-y)*scale;
			var dmax=1900,dxy=Math.sqrt(dxx*dxx+dyy*dyy);
			port2dist=dxy;
			if(dxy>20000){
               spot2.style.top = 3000 + 'px';return;
			}
			dxx=dxx/(dmax+dxy);
			dyy=dyy/(dmax+dxy);
			var dx=dxx*sin1-dyy*cos1;
			var dy=dxx*cos1+dyy*sin1;
            var wx0=parseInt(145/cssscale);
			var rotation = parseInt(0) + 'deg';
            var topOffset = windy-150/cssscaley+wx0*(0.5-dy*0.5*cssscale/cssscaley);
            var leftOffset = windx*(0.59)+wx0*(0.5+dx*0.5);
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(2/cssscale);
            spot2.style.width = parseInt(wx)+'px';
            spot2.style['pointer-events'] = 'none';
            spot2.style['-ms-transform'] =  "scale("+3.5+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            spot2.style['-webkit-transform'] = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            spot2.style.transform = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")";
            spot2.style.position = 'absolute';
            spot2.style.top = topOffset + 'px';
            spot2.style.left = leftOffset + 'px';			
}
var port3x=0,port3y=0;
function updatespot3(){
            if(port3x<-191){
			   port3dist=99999;
               spot3.style.top = 3000 + 'px';return;
			}
			var dxx=(port3x-x)*scale/klon;
			var dyy=(port3y-y)*scale;
			var dmax=1900,dxy=Math.sqrt(dxx*dxx+dyy*dyy);
			port3dist=dxy;
			if(dxy>20000){
               spot3.style.top = 3000 + 'px';return;
			}
			dxx=dxx/(dmax+dxy);
			dyy=dyy/(dmax+dxy);
			var dx=dxx*sin1-dyy*cos1;
			var dy=dxx*cos1+dyy*sin1;
            var wx0=parseInt(145/cssscale);
			var rotation = parseInt(0) + 'deg';
            var topOffset = windy-150/cssscaley+wx0*(0.5-dy*0.5*cssscale/cssscaley);
            var leftOffset = windx*(0.59)+wx0*(0.5+dx*0.5);
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            var wx=parseInt(2/cssscale);
            spot3.style.width = parseInt(wx)+'px';
            spot3.style['pointer-events'] = 'none';
            spot3.style['-ms-transform'] =  "scale("+3.5+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            spot3.style['-webkit-transform'] = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            spot3.style.transform = "scale("+3.5+","+(cssscale/cssscaley)+") rotate("+rotation+")";
            spot3.style.position = 'absolute';
            spot3.style.top = topOffset + 'px';
            spot3.style.left = leftOffset + 'px';			
}
function updatespotn(){
			var dx=-cos1*1.05;
			var dy=sin1*1.05;
            var wx0=parseInt(145/cssscale);
			var rotation = parseInt(0) + 'deg';
            var topOffset = windy-150/cssscaley+wx0*(0.5-dy*0.5*cssscale/cssscaley)-8;
            var leftOffset = windx*(0.59)+wx0*(0.5+dx*0.5)-4;
            var cssscale1=0.99/cssscale,cssscaley1=0.99/cssscaley;
            spotn.style['pointer-events'] = 'none';
            spotn.style['-ms-transform'] =  "scale("+1+","+(cssscale1/cssscaley1)+") rotate("+rotation+")"; /* IE 9 */
            spotn.style['-webkit-transform'] = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")"; /* Chrome, Safari, Opera */
            spotn.style.transform = "scale("+1+","+(cssscale/cssscaley)+") rotate("+rotation+")";
            spotn.style.position = 'absolute';
            spotn.style.top = topOffset + 'px';
            spotn.style.left = leftOffset + 'px';			
}
var cloud=[],ncloud=5;
function addcloud(){
for(var i=0;i<ncloud;i++){
  var xx=x+(Math.random()-0.5)*1000*klon/scale;
  var yy=y+(Math.random()-0.5)*1000/scale;
  var zz=z+(Math.random()-0.5)*100;
  cloud[i]=myviewer.entities.add({
        position : myCesium.Cartesian3.fromDegrees(xx,yy,zz),
        billboard :{
            image : '../images/Cesium_Logo_overlay.png'
        }
    });}
}
var sky;
function addsky(){
  var dr=90000/scale;
  var xx=x+klon*dr*cos1;
  var yy=y+dr*sin1;
  var zz=0;
  sky=myviewer.entities.add({
        position : myCesium.Cartesian3.fromDegrees(xx,yy,zz),
        billboard :{
            image : skydomejpg ,
                position : myCesium.Cartesian3.fromDegrees(xx,yy),
                show : true, // default
                //pixelOffset : new myCesium.Cartesian2(400, 400), // default: (0, 0)
                //eyeOffset : new myCesium.Cartesian3(0.0, 0.0, 0.0), // default
                //horizontalOrigin : myCesium.HorizontalOrigin.LEFT,//CENTER, // default
                //verticalOrigin : myCesium.VerticalOrigin.BOTTOM, // default: CENTER
                scale : 2.2, // default: 1.0
                //imageIndex : 0, // default: -1
                //color : myCesium.Color.LIME, // default: WHITE
                //rotation : 45, // default: 0.0
                //alignedAxis : myCesium.Cartesian3.ZERO, // default
                width : windx*2, // default: undefined
                height :windy*2 // default: undefined
        }
    });
}
function updatesky(){
if(tourelle==0){
  var dr=90000/scale,dr2=-2*dr*o1/180;
  var xx=x+klon*dr*cos1-klon*dr2*sin1;
  var yy=y+dr*sin1+dr2*cos1;
  //var zz=0;if(sin2>0){zz=dr*sin2*sin2;}
  sky.position= myCesium.Cartesian3.fromDegrees(xx,yy);
  sky.billboard.position= myCesium.Cartesian3.fromDegrees(xx,yy);
  sky.billboard.rotation=degtorad(-o3);
}else{
  var dr=90000/scale,dr2=-2*dr*(o1+to1)/180;
  var co1=Math.cos(degtorad(o1+to1)),si1=Math.sin(degtorad(o1+to1));
  var xx=x+klon*dr*co1-klon*dr2*si1;
  var yy=y+dr*si1+dr2*co1;
  //var zz=0;if(sin2>0){zz=dr*sin2*sin2;}
  sky.position= myCesium.Cartesian3.fromDegrees(xx,yy);
  sky.billboard.position= myCesium.Cartesian3.fromDegrees(xx,yy);
  sky.billboard.rotation=degtorad(0);
}
sky.billboard.width=windx*2;
sky.billboard.height=windy*2;
}

var map,marker,maplatlng,tmap=0;
function initgooglemap(){
    map=new google.maps.Map(document.getElementById('mapdiv'), {
    center: new google.maps.LatLng(lat,lng),
    disableDefaultUI:true,
	mapTypeId: google.maps.MapTypeId.HYBRID,
	zoom: 14 });
    marker = new google.maps.Marker({
    map: map,
    position: new google.maps.LatLng(lat,lng)
  });
  google.maps.event.addListener(map, 'click', function(event) {
    maplatlng = event.latLng;
    lat=maplatlng.lat();
	lng=maplatlng.lng();
	tmap=0;subflyto(lng,lat);
  });
}
function updatemarker(){
  marker.setMap(null);lng=x;lat=y;
  marker=null;
  marker = new google.maps.Marker({
    map: map,
    position: new google.maps.LatLng(lat,lng)
  });  
}
function subcentermap(){
scrollTo(0,4000);lng=x;lat=y;
maplatlng=new google.maps.LatLng(lat,lng);
map.setCenter(maplatlng);
updatemarker();
setTimeout("scrollTo(0,4000);",3000);
}
function hidemap(){return;
var mapdiv=document.getElementById('mapdiv');
mapdiv.setAttribute('style',"position:absolute;top:4022px;left:0px;width:0%;height:0%;");
google.maps.event.trigger(map, 'resize');
}
function showmap(){return;
var mapdiv=document.getElementById('mapdiv');
mapdiv.setAttribute('style',"position:absolute;top:4022px;left:0px;width:100%;height:95%;");
google.maps.event.trigger(map, 'resize');
}
function quitmsgmap(){
document.getElementById('mapdiv').blur();
scrollTo(0,0);tmap=0;//alert('ok');
}
var tvolume=0,tspeed=0,tgaz=0;
function setvolume(){
    var kvol=(1.7/vrunmax);kvol=Math.sqrt(kvol*Math.sqrt(kvol));
    var volume=kvol*(0.09+(Math.max(0,vplane)*0.4047+vrun*0.4033)*0.9);
	if(tgaz==1){if(vrun>vrunmax){volume+=0.27;}else{volume+=0.025;}}
	if(volume>1){volume=1;};
    var speed=kvol*(0.14+(Math.max(0,vplane)*0.7+vrun*0.1)*0.9);
	if(tgaz==1){speed+=0.27;}
	if(speed>1){speed=1;};
	if(Math.abs(tvolume-volume)<0.005 && Math.abs(tspeed-speed)<0.005){return;}
	tvolume=volume;tspeed=speed;
	var volume0=0.45*volume,volume1=0.32*volume;
	//var volume0=0.35*volume,volume1=0.85*volume;
if(twebaudio==1){
  if(plane=="alphajet"){
	setvol(myaudio,0.002);
	setvol(myaudiojet,volume*0.5);
	setspeed(myaudiojet,speed+0.54);
  }else if(plane=="f14"){
	setvol(myaudio,0.002);
	setvol(myaudiojet,volume*0.5);
	setspeed(myaudiojet,speed+0.54);
  }else{
	setvol(myaudio,volume*0.5);
	setvol(myaudiojet,0.002);
	setspeed(myaudio,speed+0.54);
  }
  }  
}
var xmlhttp,httpstatus=0;
function httpGet(url,callback) 
{
  xmlhttp=null;
  xmlhttp = new XMLHttpRequest();
  if ("withCredentials" in xmlhttp) {
    // Check if the XMLHttpRequest object has a "withCredentials" property.
    // "withCredentials" only exists on XMLHTTPRequest2 objects.
    //alert("withCredentials");
	xmlhttp.open("GET", url, true);
  } else if (typeof XDomainRequest != "undefined") {
    // Otherwise, check if XDomainRequest.
    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
    xmlhttp = new XDomainRequest();
	//alert("XDomainRequest");
    xmlhttp.open("GET", url);
  } else {
    // Otherwise, CORS is not supported by the browser.
    xmlhttp = null;
	alert("cors crossdomain not supported by browser");
	return;
  }
	xmlhttp.onreadystatechange=function()
    {
		if(xmlhttp.readyState==4){httpstatus=xmlhttp.status;
		    if(httpstatus>400){
			   if(loading==1){
			      setTimeout("if(loading==1 && httpstatus>400){loading=0;};",8000);}}}
        if(xmlhttp.readyState==4 && xmlhttp.status==200){callback(xmlhttp.responseText);}
    }	
    //xmlhttp.open("GET", theUrl, false);
    xmlhttp.send();    
}
var wayjson,ways=[],nairport=0,airportname=[],airportnode=[];
function waycallback(r){//alert(r);
  wayjson=JSON.parse(r);
  var msg="";
  nairport=0;
  ways=[];airportname=[];airportnode=[];
  if(wayjson.elements){ways=wayjson.elements;}
  msg+="len="+ways.length;
  if(ways.length>0){
  for(var i=0;i<ways.length;i++){
   var way=(ways[i]);
   /*for(var j=0;j<way.nodes.length;j++){
      //if(i<2){msg+="/"+way.nodes[j];};
	  nnode+=1;
	  }*/
   if(way.tags && way.nodes){
      if(way.tags.name){nairport+=1;airportname[nairport]=way.tags.name;
	                    airportnode[nairport]=way.nodes[0];
						msg+=" /"+way.tags.name;}}
   //if(ways[i].nodes){nnode+=ways[i].nodes.length;}
   }}
  //alert("nairport="+nairport+" "+msg);
  if(nairport>0){setTimeout("getnodes3();",300);}
  else{tloading=0;}
}
var nodejson3,nodes3=[],latnodes=[],lonnodes=[];
function nodecallback3(r){//alert(r);
  nodejson3=JSON.parse(r);
  var msg="";
  nodes3=[];latnodes=[];lonnodes=[];
  if(nodejson3.elements){nodes3=nodejson3.elements;}
  msg+="len3="+nodes3.length;
  for(var i=0;i<nodes3.length;i++){
     /*if(i<5){
	  msg+="/ nodeid3="+nodes3[i].id;
	  msg+=" lat="+nodes3[i].lat;
	  msg+=" lon="+nodes3[i].lon;
	  }*/
	 var inode=nodes3[i].id; 
	 latnodes[inode]=nodes3[i].lat;
     lonnodes[inode]=nodes3[i].lon;
	 }
  var iport=0;
  port0x=-199;port1x=-199;port2x=-199;port3x=-199;  
  for(var i=1;i<=nairport;i++){
     var inode=airportnode[i];
	 if(latnodes[inode]){
	    msg+=" /"+airportname[i];
	    if(iport==0){port0x=lonnodes[inode];port0y=latnodes[inode];port0name=airportname[i];}
	    if(iport==1){port1x=lonnodes[inode];port1y=latnodes[inode];port1name=airportname[i];}
	    if(iport==2){port2x=lonnodes[inode];port2y=latnodes[inode];port2name=airportname[i];}
	    if(iport==3){port3x=lonnodes[inode];port3y=latnodes[inode];port3name=airportname[i];}
		iport+=1;if(iport>3){break;}
	 }
  }	 
  //alert(msg);
  tloading=0;  
}
var tloading=0,http="http:",overpass="";
function getways(){
if(tframe<tloading){return;}
tloading=tframe+40000;
var dx=18*360/40000;
var lat1=lat-dx,lon1=lng-dx*klon;
var lat2=lat+dx,lon2=lng+dx*klon;
var latlon="%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29";
http="http:";
if(document.location.href.indexOf("https")>=0){
   http="https:";}
//http="http:";
overpass="//overpass.osm.rambler.ru/cgi/";
overpass="//overpass-api.de/api/";
//overpass="//api.openstreetmap.fr/oapi/";
if(http=="https:"){overpass="//overpass-api.de/api/";}
//var wayurl=http+overpass+"interpreter?data=[out:json];%28way[aeroway~'aerodrome|runway']"+latlon+";";
var wayurl=http+overpass+"interpreter?data=[out:json];%28way[aeroway~'aerodrome']"+latlon+";";
wayurl+="%29%3Bout%201999%3B";
try{		
httpGet(wayurl,waycallback);
}catch (e){alert("error getways");loading=0;}
}
function getnodes3(){
var nodeurl3=http+overpass+"interpreter?data=[out:json];%28";
for(var i=1;i<=nairport;i++){
    nodeurl3+="node%28"+airportnode[i]+"%29";
	if(i<nairport){nodeurl3+=";";}
	}
nodeurl3+="%29%3Bout%20skel%201999%3B";
try{		
httpGet(nodeurl3,nodecallback3);
}catch (e){alert("error getnodes3");loading=0;}
}
function formatname(text){
var text1="",c="";
var abc="abcdefghijklmnopqrstuvwxyzéèàçùABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ,;:!?.-'";
for(var i=0;i<text.length;i++){c=text.substr(i,1);
    if(abc.indexOf(c)>=0){text1+=c;}else{text1+=" ";}}
return text1.trim();
}
function speak(msg){
var voicename="UK English Female";
//var msg1=replaceall(msg," ","+");
responsiveVoice.speak(formatname(msg),voicename);
}
function dirtext(dx,dy){
var do1=diro1(dx,dy)
switch (parseInt((do1+22.5)/45)){
	case 0:
		return "east";
	case 1:
		return "north east";
	case 2:
		return "north";
	case 3:
		return "north west";
	case 4:
		return "west";
	case -1:
	    return "south east";
	case 7:
		return "south east";
	case -2:
		return "south";
	case 6:
		return "south";
	case -3:
		return "south west";
	case 5:
		return "south west";
	case -4:
		return "west";
	default:
		return "direction";
 }
}
function airporttext(){
var portname2=formatname(portname);
if(portname2!="" && Math.random()<0.75){return portname2;}
var name="";if(Math.random()<0.4){name=" "+portname2;}
switch(parseInt(Math.random()*4)){
	case 0:
		return "ground airport"+name;
	case 1:
		return "ground control"+name;
	case 2:
		return "airport control"+name;
	case 3: 
		return "ground airport control"+name;
 }
}
function carriertext(){
switch(parseInt(Math.random()*3)){
	case 0:
		return "carrier";
	case 1:
		return "carrier control";
	case 2:
        return "aircraft carrier";
 }
} 
		
function begintext(){
switch(parseInt(Math.random()*4)){
	case 0:
		return "start";
	case 1:
		return "continue";
	case 2:
		return "begin";
	case 3: 
		return "engage";
 }
}
function approachtext(){
switch (parseInt(Math.random()*2)){
	case 0:
		return "approaching";
	case 1:
		return "your approach";
 }
}
function directiontext(){
switch (parseInt(Math.random()*2)){
	case 0:
		return "direction";
	case 1:
		return "azimut";
 }
}
var radtodeg=180/Math.PI;
function diro1(dx,dy){ 
var do1;
if (Math.abs(dx)>Math.max(0.001,0.001*Math.abs(dy))){
   if(dx>0){do1=Math.atan(dy/dx)*radtodeg;
   }else{do1=180-Math.atan(dy/Math.abs(dx))*radtodeg;}
   }
else {if(dy>0){do1=90;}else{do1=-90;};}
return do1;
}
var tairport=0;
var radiotxt="",tradio=1,portname="",portname0="",portx=0,porty=0;
var do1airport=0,do1airport0=0,distairport=0,distairport0=0;
function testradio(){
if(nairport==0 || tradio==0){return;}
if(tframe<tairport){
   if(tframe<(tairport-10000) || portname==portname0){return 0;}}
tairport=tframe+17000;
portx=-199;distairport=20000;
if(port0dist<distairport){portx=port0x;porty=port0y;portname=port0name;distairport=port0dist;}
else if(port1dist<distairport){portx=port1x;porty=port1y;portname=port1name;distairport=port1dist;}
else if(port2dist<distairport){portx=port2x;porty=port2y;portname=port2name;distairport=port2dist;}
else if(port3dist<distairport){portx=port3x;porty=port3y;portname=port3name;distairport=port3dist;}
var test=0;
if(portx<-191){return;}
   do1airport=diro1((portx-x)/klon,porty-y);
   if(portname!=portname0 || 
      Math.abs(distairport-distairport0)>(500+0.2*distairport) ||
	  Math.abs(do1airport-do1airport0)>35){
		test=1;
	  }
  if(test==0){return;}
  distairport0=distairport;
  do1airport0=do1airport;
  portname0=portname;
  if(portname==""){return;}  
  radiotxt=airporttext()+" to "+plane+" , "+begintext()+" "+approachtext()+" , "
  radiotxt+=directiontext()+" "+dirtext((portx-x)*scale/klon,(porty-y)*scale);

  //alert(radiotxt);
try{speak(radiotxt);}catch(e){};
}
function subradio(){
if(tradio==1){if(confirm("set radio off ?")){tradio=0;}}
else if(confirm("set radio on ?")){tradio=1;}
}

initgooglemap();
if (typeof Cesium !== "undefined") {
    startup(Cesium);
} else if (typeof require === "function") {
    require(["Cesium"], startup);
}
</script>
<script src="http://chungkn1400.github.io/json_osm_chung/json_osm_chung/stats.js"></script>
</body>
</html>
